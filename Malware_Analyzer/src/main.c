#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "elfx.h"
#include "utils.h"
#include "report.h"

static void usage(const char *p){ fprintf(stderr,"Usage: %s static <file> [--json] [--pretty]\n",p); }

int main(int argc, char **argv) {
    if (argc < 3) { usage(argv[0]); return 1; }
    const char *mode = argv[1], *file = argv[2];
    struct report_opts opt = {0};
    for (int i = 3; i < argc; ++i) { if (!strcmp(argv[i],"--json")) opt.json=1; else if(!strcmp(argv[i],"--pretty")) opt.pretty=1; }

    if (strcmp(mode,"static")==0) {
        unsigned char *buf=NULL; size_t len=0; char err[128]={0}; char hex[65];
        if (read_file(file,&buf,&len,err,sizeof err)!=0){ fprintf(stderr,"error: %s\n",err); return 2; }
        if (sha256_hex(buf,len,hex)!=0){ free(buf); fprintf(stderr,"sha256 failed\n"); return 2; }
        free(buf);
        struct elf_summary s={0};
        if (elf_summarize(file,&s,err,sizeof err)!=0){ fprintf(stderr,"ELF parse: %s\n",err); return 3; }
        print_static_report(file,hex,&s,&opt);
        return 0;
    }
    usage(argv[0]); return 1;
}
