#include "report.h"
#include <stdio.h>

static void print_json(const char *file, const char sha256[65], const struct elf_summary *s, int pretty) {
    const char *pad = pretty ? "  " : "";
    const char *nl = pretty ? "\n" : "";
    printf("{\n");
    printf("%s\"file\": \"%s\",%s\n", pad, file, nl);
    printf("%s\"sha256\": \"%s\",%s\n", pad, sha256, nl);
    printf("%s\"elf\": {\n", pad);
    printf("%s%s\"class\": \"%s\",%s\n", pad,pad, s->class_str, nl);
    printf("%s%s\"endian\": \"%s\",%s\n", pad,pad, s->endian_str, nl);
    printf("%s%s\"machine\": \"%s\",%s\n", pad,pad, s->machine, nl);
    printf("%s%s\"entry\": %llu,%s\n", pad,pad, (unsigned long long)s->entry, nl);
    printf("%s%s\"pie\": %s,%s\n", pad,pad, s->pie? "true":"false", nl);
    printf("%s%s\"has_symtab\": %s%s\n", pad,pad, s->has_symtab? "true":"false", nl);
    printf("%s}%s\n", pad, nl);
    printf("}%s\n", nl);
}

void print_static_report(const char *file, const char sha256[65], const struct elf_summary *s, const struct report_opts *opt) {
    if (opt && opt->json) print_json(file, sha256, s, opt->pretty);
    else {
        printf("File: %s\n", file);
        printf("SHA-256: %s\n", sha256);
        printf("ELF: %s %s %s entry=0x%llx PIE=%s symtab=%s\n",
               s->class_str, s->endian_str, s->machine, (unsigned long long)s->entry,
               s->pie? "yes":"no", s->has_symtab? "yes":"no");
    }
}
